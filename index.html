<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmos Music Player</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <style>
        html,
        body {
            height: 100vh;
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
        }

        body {
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            position: relative;
        }

        /* Animated stars background */
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        * {
            font-family: Inter, Arial, sans-serif;
            font-weight: 500;
            letter-spacing: -0.5px;
            box-sizing: border-box;
        }

        body {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        a {
            text-decoration: none;
        }

        .cosmic-glass {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 32px;
            border-radius: 1.5rem;
            border: 1px solid rgba(138, 43, 226, 0.3);
            background: rgba(15, 15, 35, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow:
                inset 0 2px 4px rgba(138, 43, 226, 0.1),
                0 8px 32px rgba(75, 0, 130, 0.3);
            color: #ffffff;
            font-size: 24px;
            transition: all 0.3s ease;
            position: relative;
        }

        .cosmic-glass::before {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: 1.5rem;
            padding: 1px;
            background: linear-gradient(135deg,
                    rgba(138, 43, 226, 0.5) 0%,
                    rgba(75, 0, 130, 0.3) 50%,
                    rgba(138, 43, 226, 0.5) 100%);
            -webkit-mask:
                linear-gradient(#fff 0 0) content-box,
                linear-gradient(#fff 0 0);
            mask:
                linear-gradient(#fff 0 0) content-box,
                linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }

        input {
            outline: none;
        }

        .input-wrapper:has(input:focus) {
            background: rgba(138, 43, 226, 0.15);
            border-color: rgba(138, 43, 226, 0.5);
        }

        .result img {
            border-radius: 12px;
            margin-left: -10px;
        }

        .result .title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #fff;
        }

        .result .artist {
            font-size: 13px;
            color: #b8b8ff;
        }

        .result {
            transition: all 0.3s cubic-bezier(.34, 1.56, .64, 1);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .result:hover {
            cursor: pointer;
            background: rgba(138, 43, 226, 0.15);
            transform: translateX(5px);
        }

        .like-btn {
            margin-left: auto;
            background: none;
            border: none;
            color: #888;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px;
        }

        .like-btn:hover {
            color: #ff69b4;
            transform: scale(1.2);
        }

        .like-btn.liked {
            color: #ff69b4;
        }

        #cover-img {
            width: 280px;
            height: 280px;
            border-radius: 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 20px 40px rgba(138, 43, 226, 0.4);
        }

        #cover-img i {
            font-size: 80px;
            color: #ffffff;
            opacity: 0.4;
        }

        .player-pane h1 {
            margin-top: 20px;
            font-size: 22px;
            color: #ffffff;
            position: relative;
            left: 50%;
            transform: translateX(-50%);
            width: 280px;
            text-align: center;
        }

        .player-pane p {
            font-size: 14px;
            color: #b8b8ff;
            margin-top: -10px;
            position: relative;
            left: 50%;
            transform: translateX(-50%);
            width: 280px;
            text-align: center;
        }

        .progress-bar {
            width: 280px;
            height: 6px;
            background: rgba(138, 43, 226, 0.2);
            border-radius: 4px;
            margin: 15px auto 0 auto;
            overflow: hidden;
            cursor: pointer;
        }

        .progress-inner {
            width: 0;
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.8);
            border-radius: 4px;
            transition: width 0.1s linear;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        .controls button {
            transition: all 0.3s cubic-bezier(.34, 1.56, .64, 1);
            font-size: 20px;
        }

        .controls button:hover {
            transform: scale(1.1);
            background: rgba(138, 43, 226, 0.25);
            box-shadow: 0 8px 32px rgba(138, 43, 226, 0.4);
        }

        #results {
            overflow-y: auto;
            height: 90%;
            overflow-x: hidden;
            padding-right: 7px;
        }

        ::-webkit-scrollbar {
            width: 4px;
            background: rgba(138, 43, 226, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            background: rgba(138, 43, 226, 0.1);
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 12px;
            color: #b8b8ff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .tab-btn:hover {
            background: rgba(138, 43, 226, 0.2);
        }

        .tab-btn.active {
            background: rgba(138, 43, 226, 0.3);
            color: #fff;
            border-color: rgba(138, 43, 226, 0.5);
        }

        .progress-timers {
            width: 280px;
            position: relative;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 5px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
        }

        .progress-timers span {
            color: #b8b8ff;
            font-size: 11px;
        }
    </style>
</head>

<body>
    <div class="stars" id="stars"></div>

    <div class="cosmic-glass" style="width: 700px; height: 550px;">
        <div class="search-pane" style="width: 50%; height: 95%; display: flex; flex-direction: column;">
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('search')">
                    <i class="fas fa-search"></i> Search
                </button>
                <button class="tab-btn" onclick="switchTab('liked')">
                    <i class="fas fa-heart"></i> Liked
                </button>
            </div>
            
            <div id="search-tab">
                <div class="input-wrapper cosmic-glass" style="padding: 0; margin-bottom: 15px;">
                    <input type="text" id="search-input"
                        style="background: transparent; border-radius: 2rem; font-size: 16px; border: none; padding: 0.8rem; color: white; width: 100%;"
                        placeholder="Search for a song...">
                </div>
                <div id="results"></div>
            </div>
            
            <div id="liked-tab" style="display: none; height: 100%; overflow-y: auto;">
                <div id="liked-results"></div>
            </div>
        </div>
        
        <div class="player-pane" style="width: 50%; height: 95%; position: relative;">
            <div id="cover-img">
                <i class="fas fa-compact-disc"></i>
            </div>
            <h1 id="song-name">No track</h1>
            <p id="artist-name">Search for music to begin your journey</p>
            <div class="progress-bar">
                <div class="progress-inner"></div>
            </div>
            <div class="progress-timers">
                <span id="current-time">0:00</span>
                <span id="total-time">0:00</span>
            </div>
            <div class="controls">
                <button class="cosmic-glass" id="prev-btn"><i class="fas fa-backward"></i></button>
                <button class="cosmic-glass" id="play-btn"><i class="fas fa-play"></i></button>
                <button class="cosmic-glass" id="next-btn"><i class="fas fa-forward"></i></button>
            </div>
        </div>
    </div>

    <audio id="audio-player" style="display: none;" crossorigin="anonymous"></audio>
    <script src="https://cdn.jsdelivr.net/npm/dashjs@4.5.0/dist/dash.all.min.js"></script>

    <script>
        // Generate stars
        const starsContainer = document.getElementById('stars');
        for (let i = 0; i < 100; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 100 + '%';
            star.style.animationDelay = Math.random() * 3 + 's';
            starsContainer.appendChild(star);
        }

        const API_BASE = 'https://corsproxy.io/?https://wolf.qqdl.site';

        // Liked songs storage
        const LikedSongs = {
            get() {
                const liked = localStorage.getItem('cosmosLikedSongs');
                return liked ? JSON.parse(liked) : [];
            },
            save(songs) {
                localStorage.setItem('cosmosLikedSongs', JSON.stringify(songs));
            },
            add(track) {
                const liked = this.get();
                if (!liked.find(t => t.id === track.id)) {
                    liked.push(track);
                    this.save(liked);
                }
            },
            remove(trackId) {
                const liked = this.get().filter(t => t.id !== trackId);
                this.save(liked);
            },
            isLiked(trackId) {
                return this.get().some(t => t.id === trackId);
            }
        };

        class MusicAPI {
            async search(query) {
                try {
                    const response = await fetch(`${API_BASE}/search?s=${encodeURIComponent(query)}`);
                    const json = await response.json();
                    
                    const data = json.data || json;
                    const items = (data.items || []).map(item => ({ ...item, _type: 'track' }));
                    
                    return { items };
                } catch (e) {
                    console.error('Search error:', e);
                    return { items: [] };
                }
            }

            async getTrack(id) {
                try {
                    const response = await fetch(`${API_BASE}/track/?id=${id}`);
                    return await response.json();
                } catch (e) {
                    return null;
                }
            }

            extractStreamUrlFromManifest(manifest) {
                try {
                    const decoded = atob(manifest);

                    if (decoded.includes('<MPD')) {
                        const blob = new Blob([decoded], { type: 'application/dash+xml' });
                        const blobUrl = URL.createObjectURL(blob);
                        return blobUrl;
                    }

                    try {
                        const parsed = JSON.parse(decoded);
                        if (parsed?.urls?.[0]) {
                            return parsed.urls[0];
                        }
                    } catch {}
                    
                    const match = decoded.match(/https?:\/\/[\w\-.~:?#[@!$&'()*+,;=%/]+/);
                    if (match) {
                        return match[0];
                    }
                } catch (error) {}
                return null;
            }

            getCoverUrl(id, size = '320') {
                if (!id) return `https://picsum.photos/seed/${Math.random()}/${size}`;
                if (typeof id === 'string' && (id.startsWith('http') || id.startsWith('blob:') || id.startsWith('assets/'))) {
                    return id;
                }
                const formattedId = id.replace(/-/g, '/');
                return `https://resources.tidal.com/images/${formattedId}/${size}x${size}.jpg`;
            }

            getItemTitle(item) {
                return item.title || 'Unknown';
            }

            getItemSubtitle(item) {
                return item.artist?.name || '';
            }

            getItemCover(item) {
                return item.album?.cover;
            }
        }

        class Player {
            constructor(audioElement) {
                this.audio = audioElement;
                this.queue = [];
                this.currentIndex = 0;
                this.listeners = [];
                this.dashPlayer = null;

                this.audio.addEventListener('play', () => this.notify('play'));
                this.audio.addEventListener('pause', () => this.notify('pause'));
                this.audio.addEventListener('ended', () => this.playNext());
                this.audio.addEventListener('timeupdate', () => this.notify('timeupdate'));
                this.audio.addEventListener('error', () => this.notify('error'));
            }

            setQueue(tracks) {
                this.queue = tracks;
                this.currentIndex = 0;
            }

            async play(track) {
                try {
                    const trackData = await api.getTrack(track.id);

                    if (trackData?.data?.manifest) {
                        const streamUrl = api.extractStreamUrlFromManifest(trackData.data.manifest);
                        
                        if (streamUrl && streamUrl.startsWith('blob:')) {
                            if (typeof dashjs !== 'undefined') {
                                if (!this.dashPlayer) {
                                    this.dashPlayer = dashjs.MediaPlayer().create();
                                }
                                this.dashPlayer.initialize(this.audio, streamUrl, true);
                                this.notify('track-changed');
                            }
                        } else if (streamUrl) {
                            this.audio.src = streamUrl;
                            this.audio.play().then(() => this.notify('track-changed'));
                        }
                    }
                } catch (e) {
                    console.error('Play error:', e);
                }
            }

            playPause() {
                if (this.audio.paused) {
                    this.audio.play();
                } else {
                    this.audio.pause();
                }
            }

            playNext() {
                if (this.currentIndex < this.queue.length - 1) {
                    this.currentIndex++;
                    this.play(this.queue[this.currentIndex]);
                }
            }

            playPrev() {
                if (this.currentIndex > 0) {
                    this.currentIndex--;
                    this.play(this.queue[this.currentIndex]);
                }
            }

            getCurrentTrack() {
                return this.queue[this.currentIndex];
            }

            on(event, callback) {
                this.listeners.push({ event, callback });
            }

            notify(event) {
                this.listeners.forEach(({ event: e, callback }) => {
                    if (e === event) callback();
                });
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        const debounce = (func, wait) => {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        };

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        const api = new MusicAPI();
        const player = new Player(document.getElementById('audio-player'));
        let currentSearchResults = [];
        let currentTab = 'search';

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.tab-btn').classList.add('active');
            
            if (tab === 'search') {
                document.getElementById('search-tab').style.display = 'block';
                document.getElementById('liked-tab').style.display = 'none';
            } else {
                document.getElementById('search-tab').style.display = 'none';
                document.getElementById('liked-tab').style.display = 'block';
                displayLikedSongs();
            }
        }

        function toggleLike(track, event) {
            event.stopPropagation();
            if (LikedSongs.isLiked(track.id)) {
                LikedSongs.remove(track.id);
            } else {
                LikedSongs.add(track);
            }
            
            if (currentTab === 'search') {
                performSearch(document.getElementById('search-input').value);
            } else {
                displayLikedSongs();
            }
        }

        function displayLikedSongs() {
            const liked = LikedSongs.get();
            const container = document.getElementById('liked-results');
            
            if (liked.length === 0) {
                container.innerHTML = '<div style="color: #999; padding: 20px; text-align: center;">No liked songs yet</div>';
                return;
            }
            
            container.innerHTML = liked.map(track => `
                <div class="result cosmic-glass" onclick='playTrack(${JSON.stringify(track).replace(/'/g, "&#39;")})'>
                    <img src="${api.getCoverUrl(track.album?.cover)}" alt="${escapeHtml(track.title)}" height="48">
                    <div class="info">
                        <div class="title">${escapeHtml(track.title)}</div>
                        <div class="artist">${escapeHtml(track.artist?.name || 'Unknown')}</div>
                    </div>
                    <button class="like-btn liked" onclick='toggleLike(${JSON.stringify(track).replace(/'/g, "&#39;")}, event)'>
                        <i class="fas fa-heart"></i>
                    </button>
                </div>
            `).join('');
        }

        const performSearch = debounce(async (query) => {
            if (!query.trim()) {
                document.getElementById('results').innerHTML = '<div style="color: #999; padding: 20px;">Start typing to search the cosmos...</div>';
                return;
            }

            document.getElementById('results').innerHTML = '<div style="color: #999; padding: 20px;">Searching the cosmos...</div>';
            const results = await api.search(query);

            if (results.items && results.items.length > 0) {
                currentSearchResults = results.items.filter(item => item._type === 'track');
                document.getElementById('results').innerHTML = results.items
                    .map((item) => {
                        const isLiked = LikedSongs.isLiked(item.id);
                        return `
                            <div class="result cosmic-glass" onclick='playTrack(${JSON.stringify(item).replace(/'/g, "&#39;")})'>
                                <img src="${api.getCoverUrl(item.album?.cover)}" alt="${escapeHtml(item.title)}" height="48">
                                <div class="info">
                                    <div class="title">${escapeHtml(item.title)}</div>
                                    <div class="artist">${escapeHtml(item.artist?.name || 'Unknown')}</div>
                                </div>
                                <button class="like-btn ${isLiked ? 'liked' : ''}" onclick='toggleLike(${JSON.stringify(item).replace(/'/g, "&#39;")}, event)'>
                                    <i class="fas fa-heart"></i>
                                </button>
                            </div>
                        `;
                    }).join('');
            } else {
                document.getElementById('results').innerHTML = '<div style="color: #999; padding: 20px;">No results found in the cosmos</div>';
            }
        }, 300);

        document.getElementById('search-input').addEventListener('input', (e) => {
            performSearch(e.target.value);
        });

        function playTrack(track) {
            player.setQueue(currentTab === 'search' ? currentSearchResults : LikedSongs.get());
            const queue = currentTab === 'search' ? currentSearchResults : LikedSongs.get();
            const trackIndex = queue.findIndex(t => t.id === track.id);
            if (trackIndex !== -1) {
                player.currentIndex = trackIndex;
            }
            player.play(track);
            updateNowPlaying(track);
        }

        function updateNowPlaying(track) {
            if (track) {
                document.getElementById('song-name').textContent = track.title || 'Unknown';
                document.getElementById('artist-name').textContent = track.artist?.name || 'Unknown Artist';
                const imgSrc = api.getCoverUrl(track.album?.cover);
                document.getElementById('cover-img').innerHTML = `<img src="${imgSrc}" style="width: 100%; height: 100%; border-radius: 1.5rem; object-fit: cover;">`;
                if (track.duration) {
                    document.getElementById('total-time').textContent = formatTime(track.duration);
                }
            }
        }

        document.getElementById('play-btn').addEventListener('click', () => player.playPause());
        document.getElementById('prev-btn').addEventListener('click', () => player.playPrev());
        document.getElementById('next-btn').addEventListener('click', () => player.playNext());

        document.querySelector('.progress-bar').addEventListener('click', (e) => {
            const rect = e.currentTarget.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            player.audio.currentTime = percent * player.audio.duration;
        });

        player.on('timeupdate', () => {
            const duration = player.audio.duration || 0;
            const current = player.audio.currentTime || 0;
            
            if (duration > 0 && !isNaN(duration)) {
                const percent = (current / duration) * 100;
                document.querySelector('.progress-inner').style.width = `${percent}%`;
                document.getElementById('current-time').textContent = formatTime(current);
                if (document.getElementById('total-time').textContent === '0:00') {
                    document.getElementById('total-time').textContent = formatTime(duration);
                }
            }
        });

        player.on('play', () => {
            document.getElementById('play-btn').innerHTML = '<i class="fas fa-pause"></i>';
        });

        player.on('pause', () => {
            document.getElementById('play-btn').innerHTML = '<i class="fas fa-play"></i>';
        });

        player.on('track-changed', () => {
            updateNowPlaying(player.getCurrentTrack());
        });
    </script>

</body>

</html>
